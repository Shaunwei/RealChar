name: Build Push and Deploy Docker Image

on:
  release:
    types: [published]  # This triggers the workflow when a release is published

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to DockerHub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        push: true
        tags: shaunly/real_char:latest

    - id: 'auth'
      name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS_REBYTE }}'

    - id: 'get-credentials'
      uses: 'google-github-actions/get-gke-credentials@v1'
      with:
        cluster_name: 're-dev'
        location: 'us-west3'

    - id: 'deploy-to-cluster'
      run: 'kubectl rollout restart deployment deployment-rc-api'

    - name: Slack Notification
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_COLOR: '#fb5c05'
        SLACK_MESSAGE: new version has been updated for realchar api server in dev env
        SLACK_TITLE: dev realchar api server (backend) update
        SLACK_WEBHOOK: https://hooks.slack.com/services/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

    # - name: Install and configure kubectl
    #   uses: azure/setup-kubectl@v1
    #   with:
    #     version: 'v1.20.0'

    # - name: Deploy to Kubernetes
    #   run: |
    #     echo "${{ secrets.KUBECONFIG }}" | base64 --decode > ./kubeconfig.yaml
    #     export KUBECONFIG=./kubeconfig.yaml
    #     kubectl rollout restart deployment realchar-dev-deployment
